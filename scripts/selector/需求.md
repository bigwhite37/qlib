# 1 — 目标产物

生成一个 Python 模块（例如 `ai_stock_selector.py`），可直接 `python ai_stock_selector.py --train` 训练、`--predict` 预测、`--backtest` 回测。核心满足下列要求。

---

# 2 — 技术框架

## 2.1 数据

- 优先本地 Qlib 数据

```python
provider_uri = os.path.expanduser("~/.qlib/qlib_data/cn_data")
if not Path(provider_uri).exists() or missing_dates():   # self-defined checker
    from akshare import stock_zh_a_hist_min_em                # 示例
    download_latest_data_with_akshare(provider_uri)           # 请实现
qlib.init(provider_uri=provider_uri, region=REG_CN)
```

- 如本地缺失所需日期区间或股票，调用 AkShare 获取日线（收、开、高、低、量、金额等）并补齐，再 `qlib.data.writer.write()` 写入本地。

---

## 2.2 策略逻辑（摘自文档 §2 & §3）

### 2.2.1 因子工程：价格-动量、估值-质量、情绪-事件三大块

| 因子簇     | 代表公式（Qlib 表达式） | 说明 & 典型超额效果 |
|------------|-------------------------|--------------------|
| 动量/趋势   | `Mean($close,5)/Ref($close,1)-1` (5 日动量)<br>`($close-Mean($close,20))/Mean($close,20)` (布林带位置)<br>`MACD(12,26,9)` 信号线差分 | A 股动量因子年化超额 ≈ 9–12% |
| 估值/质量   | `$pe_ttm`、`$pb`、`$roe`、`Rank(ToFloat($net_profit_q/Ref($total_mv,1)))` | 估值 + 盈利质量组合在 A 股长期有效 |
| 量价/波动   | `($high-$low)/$low` (振幅)<br>`Std($close/Ref($close,1),10)` (近 10 日波动)<br>`$volume/Mean($volume,20)` | 量能过滤可抑制假突破 |
| 情绪/事件   | `EarningsPreAnnounce>0` (AkShare 财报预增占位符)<br>`DragonTiger==1` (龙虎榜事件)<br>`SentimentScore` (新闻情绪) | 事件驱动在 A 股短期 α 显著 |
| 逆势/回转   | `Ref($close,5)/$close-1` (5 日反转)<br>MACD 量价背离信号 | 回转因子与动量做多样化匹配 |

**实现提示：**
- 使用 AkShare 接口如 `stock_financial_analysis_indicator_em`、`stock_lhb_detail_em` 抓取预增、龙虎榜字段；用 `nlp_news()` 抓取新闻并调用情绪模型打分。
- `DragonTiger`/`EarningsPreAnnounce` 等先存 CSV，再用 Qlib 的 `LocalFeatureLoader` 注入自定义字段。

---

### 2.2.2 行业 & 市值中性化

- 先用 Wind/中信行业分类映射（AkShare 接口 `stock_industry_cons_ths`），生成 `industry` 列；
- 调用 Qlib 的 `CSZScoreNorm(fields_group="feature", groupby_cols=["industry","size_bucket"])`；
- `size_bucket` 按总市值五等分。这样可显著抑制大盘风格漂移。

---

### 2.2.3 模型架构：LightGBM + XGBoost + Transformer Stack

1. **Base learners**
    - LightGBM（tree_num=1200, lr=0.02, num_leaves=256, colsample=0.8）
    - XGBoost（n_estimators=800, max_depth=8, subsample=0.8）
2. **Sequence learner**
    - pytorch_transformer — 输入近 30 天按日期拼接的因子矩阵，d_model=64, nhead=8, n_layers=2
3. **Stacking**
    - 用 Qlib LinearEnsemble (weights via 5-fold CV) 集成三者。

> 栈式集成在中国市场能显著提升 IC 至 0.07+

---

### 2.2.4 调仓与权重优化

- 调仓频率：每月最后五个交易日取均值预测，T+1 调仓；
- 组合优化：使用 cvxpy 在约束 `w_i ≤ 0.15`、`Σ|Δw_i| ≤ 0.8`、`β_market ≈ 0` 下，最大化 `Σ w_i * pred`；
- 失败约束回退到 TopK 等权。

> 限制换手后可将年化换手率降至 < 300%，减少 15–20 bp 成本。

---

### 2.2.5 风险控制 & 仓位管理

- 动态止损：若单票回撤 > 25 % 或持仓超 30 日未创新高，则减仓 50 %；
- 组合 VaR 限制：日内 95% VaR 不超净值 1.5 %；超限自动降杠杆。
- 黑名单：ST、停牌、退市、财务造假处罚 3 年内个股全部过滤。

---

### 2.2.6 回测指标 & 单元阈值

| 指标           | 目标区间           |
|----------------|--------------------|
| IC_mean        | ≥ 0.06             |
| IC_IR          | ≥ 0.5              |
| annual_return  | 15 % – 60 %        |
| max_drawdown   | > –50 %            |
| sharpe         | 0.8 – 2.5          |
| avg_turnover   | < 1.0              |
| win_rate       | > 0.52             |

> 单元测试若不满足即 AssertionError。

---

# 3 — 模块接口

```shell
python ai_stock_selector.py --prepare_data   # 下载&写入
python ai_stock_selector.py --train          # 训练 & 保存模型 (.pkl)
python ai_stock_selector.py --predict        # 生成最新 signal.csv
python ai_stock_selector.py --backtest       # 回测并输出指标 & equity_curve.csv
```

---

# 4 — 实现细节

- 所有路径使用 Path，支持 Windows/Linux。
- 随机种子 42；可多线程但保持确定性。
- 抛出友好异常：本地无数据、AkShare 调用失败、模型包缺失等。
- 代码需注释简短，函数粒度清晰：`fetch_data_with_akshare()`、`prepare_dataset()`、`train_model()`、`run_backtest()`、`calc_metrics()`。

---

# 5 — 交付文件

1. `ai_stock_selector.py`
2. `requirements.txt`（qlib>=0.9, akshare, lightgbm, …）
3. 示例运行日志 & `equity_curve_sample.csv`（前 5 行）

> 请严格按以上规格生成代码；若依赖缺失须给出 pip install 指令。